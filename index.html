<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Pinoy 14-Day Meal Planner</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { color: #333; }
    label { display: block; margin-top: 10px; }
    input, select { margin-top: 5px; padding: 5px; }
    button { margin-top: 10px; padding: 5px 12px; }
    pre { background: #fff; padding: 15px; border: 1px solid #ddd; white-space: pre-wrap; }
    .profile-box { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h1>Pinoy 14-Day Meal Planner (PDF + Edit)</h1>

  <!-- Profile Management -->
  <div>
    <h3>Add / Edit Profile</h3>
    <label>Name: <input id="pname" type="text" required></label>
    <label>Age: <input id="age" type="number" required></label>
    <label>Weight (kg): <input id="weight" type="number" required></label>
    <label>Height (cm): <input id="height" type="number" required></label>
    <label>Gender:
      <select id="gender" required>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </label>
    <label>Activity Level:
      <select id="activity" required>
        <option value="sedentary">Sedentary (little or no exercise)</option>
        <option value="light">Lightly Active (light exercise/sports 1-3 days/week)</option>
        <option value="moderate">Moderately Active (moderate exercise 3-5 days/week)</option>
        <option value="active">Active (hard exercise 6-7 days/week)</option>
        <option value="veryActive">Very Active (physical job or intense exercise)</option>
      </select>
    </label>
    <button onclick="addProfile()">Save Profile</button>
  </div>

  <!-- Profile Selection -->
  <div class="profile-box">
    <h3>Select Profile</h3>
    <select id="profileSelect" onchange="loadProfile()"></select>
    <button onclick="editProfile()">Edit</button>
    <button onclick="deleteProfile()">Delete</button>
  </div>

  <!-- BMR + Macro Info -->
  <div id="bmrInfo" style="margin-top: 20px; font-weight: bold;"></div>

  <!-- Actions -->
  <div>
    <button onclick="generatePlan()">Generate 14-Day Plan</button>
    <button onclick="downloadPDF()">Download PDF</button>
  </div>

  <!-- Output -->
  <pre id="output"></pre>

<script>
let profiles = JSON.parse(localStorage.getItem("profiles") || "[]");
let currentPlan = [];

// Save profile
function addProfile() {
  let profile = {
    name: document.getElementById("pname").value,
    age: parseInt(document.getElementById("age").value),
    weight: parseFloat(document.getElementById("weight").value),
    height: parseFloat(document.getElementById("height").value),
    gender: document.getElementById("gender").value,
    activity: document.getElementById("activity").value
  };

  if (!profile.name) { alert("Name required"); return; }

  let existing = profiles.findIndex(p => p.name === profile.name);
  if (existing >= 0) {
    profiles[existing] = profile;
  } else {
    profiles.push(profile);
  }
  localStorage.setItem("profiles", JSON.stringify(profiles));
  refreshProfiles();
}

// Populate dropdown
function refreshProfiles() {
  let sel = document.getElementById("profileSelect");
  sel.innerHTML = profiles.map(p => `<option>${p.name}</option>`).join("");
}
refreshProfiles();

// Load profile into form
function loadProfile() {
  let sel = document.getElementById("profileSelect");
  let p = profiles.find(x => x.name === sel.value);
  if (!p) return;
  document.getElementById("pname").value = p.name;
  document.getElementById("age").value = p.age;
  document.getElementById("weight").value = p.weight;
  document.getElementById("height").value = p.height;
  document.getElementById("gender").value = p.gender;
  document.getElementById("activity").value = p.activity;
}

function editProfile() {
  loadProfile();
}

function deleteProfile() {
  let sel = document.getElementById("profileSelect");
  let name = sel.value;
  if (!name) return;
  profiles = profiles.filter(p => p.name !== name);
  localStorage.setItem("profiles", JSON.stringify(profiles));
  refreshProfiles();
  document.getElementById("output").textContent = "";
  document.getElementById("bmrInfo").innerHTML = "";
}

// Macro calculator
function getMacros(calories) {
  let protein = (calories * 0.30) / 4;
  let carbs = (calories * 0.40) / 4;
  let fats = (calories * 0.30) / 9;
  return {
    protein: protein.toFixed(0),
    carbs: carbs.toFixed(0),
    fats: fats.toFixed(0)
  };
}

// BMR Calculation
function calculateBMR(profile) {
  let bmr;
  if (profile.gender === "male") {
    bmr = 10 * profile.weight + 6.25 * profile.height - 5 * profile.age + 5;
  } else {
    bmr = 10 * profile.weight + 6.25 * profile.height - 5 * profile.age - 161;
  }

  let factor = 1.2;
  if (profile.activity === "light") factor = 1.375;
  if (profile.activity === "moderate") factor = 1.55;
  if (profile.activity === "active") factor = 1.725;
  if (profile.activity === "veryActive") factor = 1.9;

  let maintenance = bmr * factor;
  return {
    bmr,
    maintenance,
    fatLoss: maintenance - 500,
    muscleGain: maintenance + 500,
    macros: {
      maintenance: getMacros(maintenance),
      fatLoss: getMacros(maintenance - 500),
      muscleGain: getMacros(maintenance + 500)
    }
  };
}

// Meals
let meals = {
  breakfast: {
    "Herbalife Shake": { cal: 200, protein: 17 }
  },
  lunch: {
    "Grilled Chicken + Rice": { cal: 450, protein: 40 },
    "Fish + Rice": { cal: 400, protein: 35 },
    "Lean Pork + Rice": { cal: 500, protein: 38 },
    "Tofu + Vegetables": { cal: 350, protein: 25 }
  },
  dinner: {
    "Herbalife Shake": { cal: 200, protein: 17 }
  },
  snack: {
    "Banana": { cal: 105, protein: 1 },
    "Egg": { cal: 78, protein: 6 },
    "Banana + Egg": { cal: 183, protein: 7 },
    "Salad": { cal: 120, protein: 3 },
    "Greek yogurt (100g)": { cal: 60, protein: 10 },
    "Apple": { cal: 95, protein: 0 },
    "Peanut butter (1 tbsp) with cucumber slices": { cal: 120, protein: 4 }
  }
};

// Generate unique 14-day plan
function generatePlan() {
  let sel = document.getElementById("profileSelect");
  let profile = profiles.find(x => x.name === sel.value);
  if (!profile) { alert("Select a profile"); return; }

  let calc = calculateBMR(profile);

  document.getElementById("bmrInfo").innerHTML = `
    <p>BMR: ${calc.bmr.toFixed(0)} kcal/day</p>
    <p>Maintenance: ${calc.maintenance.toFixed(0)} kcal/day 
      (P: ${calc.macros.maintenance.protein}g, C: ${calc.macros.maintenance.carbs}g, F: ${calc.macros.maintenance.fats}g)</p>
    <p>Fat Loss: ${calc.fatLoss.toFixed(0)} kcal/day 
      (P: ${calc.macros.fatLoss.protein}g, C: ${calc.macros.fatLoss.carbs}g, F: ${calc.macros.fatLoss.fats}g)</p>
    <p>Muscle Gain: ${calc.muscleGain.toFixed(0)} kcal/day 
      (P: ${calc.macros.muscleGain.protein}g, C: ${calc.macros.muscleGain.carbs}g, F: ${calc.macros.muscleGain.fats}g)</p>
  `;

  let lunches = Object.keys(meals.lunch);
  let snacks = Object.keys(meals.snack);

  let usedLunches = shuffle([...lunches]);
  let usedSnacks = shuffle([...snacks]);

  currentPlan = [];
  let out = "";

  for (let i = 1; i <= 14; i++) {
    if (usedLunches.length === 0) usedLunches = shuffle([...lunches]);
    if (usedSnacks.length === 0) usedSnacks = shuffle([...snacks]);

    let lunchKey = usedLunches.pop();
    let snackKey = usedSnacks.pop();

    let planDay = {
      day: i,
      breakfast: { name: "Herbalife Shake", ...meals.breakfast["Herbalife Shake"] },
      lunch: { name: lunchKey, ...meals.lunch[lunchKey] },
      dinner: { name: "Herbalife Shake", ...meals.dinner["Herbalife Shake"] },
      snack: { name: snackKey, ...meals.snack[snackKey] }
    };

    let totalCal = planDay.breakfast.cal + planDay.lunch.cal + planDay.dinner.cal + planDay.snack.cal;
    let totalProtein = planDay.breakfast.protein + planDay.lunch.protein + planDay.dinner.protein + planDay.snack.protein;

    planDay.totalCal = totalCal;
    planDay.totalProtein = totalProtein;

    currentPlan.push(planDay);

    out += `Day ${i}\n`;
    out += `  Breakfast: ${planDay.breakfast.name} (${planDay.breakfast.cal} cal, ${planDay.breakfast.protein}g protein)\n`;
    out += `  Lunch: ${planDay.lunch.name} (${planDay.lunch.cal} cal, ${planDay.lunch.protein}g protein)\n`;
    out += `  Dinner: ${planDay.dinner.name} (${planDay.dinner.cal} cal, ${planDay.dinner.protein}g protein)\n`;
    out += `  Snack: ${planDay.snack.name} (${planDay.snack.cal} cal, ${planDay.snack.protein}g protein)\n`;
    out += `  ðŸ‘‰ Total: ${totalCal} cal, ${totalProtein}g protein\n\n`;
  }

  document.getElementById("output").textContent = out;
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Download PDF
function downloadPDF() {
  if (currentPlan.length === 0) { alert("Generate plan first"); return; }

  let sel = document.getElementById("profileSelect");
  let profile = profiles.find(x => x.name === sel.value);
  let calc = calculateBMR(profile);

  let { jsPDF } = window.jspdf;
  let doc = new jsPDF();

  doc.setFontSize(14);
  doc.text("14-Day Meal Plan", 14, 20);
  doc.text(`Client: ${profile.name}`, 14, 30);

  doc.setFontSize(11);
  doc.text(`BMR: ${calc.bmr.toFixed(0)} kcal/day`, 14, 40);
  doc.text(`Maintenance: ${calc.maintenance.toFixed(0)} kcal/day (P:${calc.macros.maintenance.protein}g C:${calc.macros.maintenance.carbs}g F:${calc.macros.maintenance.fats}g)`, 14, 46);
  doc.text(`Fat Loss: ${calc.fatLoss.toFixed(0)} kcal/day (P:${calc.macros.fatLoss.protein}g C:${calc.macros.fatLoss.carbs}g F:${calc.macros.fatLoss.fats}g)`, 14, 52);
  doc.text(`Muscle Gain: ${calc.muscleGain.toFixed(0)} kcal/day (P:${calc.macros.muscleGain.protein}g C:${calc.macros.muscleGain.carbs}g F:${calc.macros.muscleGain.fats}g)`, 14, 58);

  let rows = currentPlan.map(p => [
    p.day,
    p.breakfast.name,
    p.lunch.name,
    p.dinner.name,
    p.snack.name,
    `${p.totalCal} cal / ${p.totalProtein}g`
  ]);

  doc.autoTable({
    head: [["Day","Breakfast","Lunch","Dinner","Snack","Daily Total"]],
    body: rows,
    startY: 65,
    styles: { fontSize: 8 }
  });

  doc.save("MealPlan.pdf");
}
</script>
</body>
</html>
