<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pinoy Meal Planner</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #0d0d0d;
    color: #d4ffd4;
  }
  body {
    display: flex;
    flex-direction: row;
    height: 100vh;
    overflow: hidden;
  }
  #sidebar {
    background-color: #1a1a1a;
    width: 280px;
    min-width: 280px;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  #sidebar h2 {
    color: #39ff14;
    text-align: center;
    margin-top: 0;
  }
  #profileList, #planList {
    list-style: none;
    padding-left: 0;
    margin: 10px 0 20px 0;
    flex-shrink: 0;
  }
  #profileList li, #planList li {
    padding: 10px;
    margin-bottom: 8px;
    background-color: #262626;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0px 0px 5px rgba(57, 255, 20, 0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #a8ffb0;
  }
  #profileList li.active, #planList li.active {
    background-color: #39ff14;
    color: black;
  }
  #profileList li:hover:not(.active),
  #planList li:hover:not(.active) {
    background-color: #2ecc71;
    color: black;
  }
  #profileList button.delete-btn, #planList button.delete-btn {
    background: transparent;
    border: none;
    color: #ff4c4c;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
    margin-left: 10px;
  }
  #profileTitle {
    margin-bottom: 6px;
    font-weight: bold;
    color: #7fff7f;
    text-align: center;
  }
  #newProfileBtn {
    margin-top: auto;
    background-color: #39ff14;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    padding: 12px;
  }
  .container {
    flex: 1;
    max-width: 700px;
    margin: auto;
    padding: 20px;
    overflow-y: auto;
    box-sizing: border-box;
  }
  h1, h2 {
    color: #39ff14;
    text-align: center;
    margin-bottom: 10px;
  }
  p {
    margin: 10px 0 5px;
  }
  select, input[type=number], input[type=text], textarea {
    width: 100%;
    padding: 8px 10px;
    border-radius: 5px;
    border: none;
    margin-bottom: 12px;
    font-size: 1em;
    box-sizing: border-box;
  }
  textarea {
    resize: vertical;
    min-height: 50px;
  }
  button {
    background-color: #39ff14;
    color: black;
    border: none;
    padding: 14px;
    margin-top: 10px;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
  }
  button:hover {
    background-color: #2ecc71;
  }
  .step {
    display: none;
    padding: 15px;
    background-color: #1a1a1a;
    border-radius: 10px;
    box-shadow: 0px 0px 15px rgba(57, 255, 20, 0.5);
  }
  .step.active {
    display: block;
  }
  .meal-card {
    background-color: #262626;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    box-shadow: 0px 0px 10px rgba(57, 255, 20, 0.2);
  }
  .meal-card h3 {
    color: #39ff14;
    margin: 6px 0;
  }
  .meal-card img {
    max-width: 100%;
    border-radius: 10px;
    margin-top: 6px;
  }
  .macro {
    font-size: 0.9em;
    color: #a8ffb0;
    margin-top: 4px;
  }
  #profileNameInput {
    margin-bottom: 15px;
  }
  #regenerateBtn {
    background-color: #ffbf00;
    color: black;
    margin-top: 0;
    width: 48%;
    margin-right: 4%;
  }
  #generateBtn {
    width: 48%;
    margin-left: 4%;
  }
  #regenerateBtn:hover {
    background-color: #e6ac00;
  }
  .button-row {
    display: flex;
    justify-content: space-between;
  }
  #sidebar::-webkit-scrollbar {
    width: 6px;
  }
  #sidebar::-webkit-scrollbar-thumb {
    background-color: rgba(57,255,20,0.5);
    border-radius: 3px;
  }
  @media (max-width: 700px) {
    body {
      flex-direction: column;
      height: 100vh;
    }
    #sidebar {
      width: 100%;
      height: 160px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      padding: 10px 10px 10px 10px;
      display: flex;
      flex-wrap: nowrap;
      flex-direction: row;
      align-items: center;
    }
    #profileList, #planList {
      display: flex;
      flex-direction: row;
      margin: 0;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(57,255,20,0.5) transparent;
      white-space: nowrap;
    }
    #profileList li, #planList li {
      display: inline-flex;
      flex-direction: column;
      justify-content: center;
      margin: 0 10px 0 0;
      min-width: 130px;
      flex-shrink: 0;
    }
    #newProfileBtn {
      margin-left: auto;
      min-width: 140px;
      flex-shrink: 0;
    }
    .container {
      max-width: 100%;
      height: calc(100vh - 160px);
      overflow-y: auto;
      padding: 15px;
    }
    #regenerateBtn, #generateBtn {
      width: 100%;
      margin: 10px 0;
    }
    .button-row {
      flex-direction: column;
    }
  }
  #weeklyMealPlans {
    margin-top: 20px;
  }
  .day-mealplan {
    border: 1px solid #39ff14;
    border-radius: 8px;
    margin-bottom: 15px;
    padding: 14px;
    background-color: #222;
  }
  .day-mealplan h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #7fff7f;
  }
  .day-mealplan .meal-card {
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Profiles</h2>
  <ul id="profileList" aria-label="List of profiles"></ul>
  <h2 id="profileTitle" style="display:none;">Past Meal Plans</h2>
  <ul id="planList" aria-label="List of past meal plans"></ul>
  <button id="newProfileBtn" aria-label="Create new profile">+ New Profile</button>
</div>

<div class="container">
  <h1>Pinoy Meal Planner</h1>

  <div id="stepContainer" role="region" aria-live="polite">
    <div id="step0" class="step" tabindex="0">
      <h2>Create Profile</h2>
      <p>Enter client name:</p>
      <input type="text" id="profileNameInput" placeholder="e.g. Juan Dela Cruz" aria-label="Client Name" />
      <button onclick="saveNewProfile()" aria-label="Save profile">Save Profile</button>
    </div>

    <div id="step1" class="step" tabindex="0">
      <h2>Step 1: Goal</h2>
      <p>Select your goal:</p>
      <select id="goal" aria-label="Select goal">
        <option value="lose">Lose Weight</option>
        <option value="gain">Gain Muscle</option>
        <option value="maintain">Maintain Weight</option>
      </select>
      <button onclick="nextStep(2)" aria-label="Next to information input">Next</button>
    </div>

    <div id="step2" class="step" tabindex="0">
      <h2>Step 2: Information</h2>
      <p>Enter your weight (kg):</p>
      <input type="number" id="weight" placeholder="e.g. 70" min="1" step="any" aria-label="Weight in kilograms"/>
      <p>Enter your height (cm):</p>
      <input type="number" id="height" placeholder="e.g. 170" min="50" max="300" step="any" aria-label="Height in centimeters"/>
      <p>Enter your age:</p>
      <input type="number" id="age" placeholder="e.g. 30" min="1" aria-label="Age in years" />
      <button onclick="nextStep(3)" aria-label="Next to target weight input">Next</button>
    </div>

    <div id="step3" class="step" tabindex="0">
      <h2>Step 3: Target Weight</h2>
      <p>Enter your target weight (kg):</p>
      <input type="number" id="targetWeight" placeholder="e.g. 65" min="1" step="any" aria-label="Target Weight in kilograms" />
      <button onclick="nextStep(4)" aria-label="Next to allergies input">Next</button>
    </div>

    <div id="step4" class="step" tabindex="0">
      <h2>Step 4: Allergies</h2>
      <p>Enter any allergies (comma separated), or leave blank if none:</p>
      <textarea id="allergyInput" placeholder="e.g. nuts, shellfish" aria-label="Client allergies input"></textarea>
      <button onclick="nextStep(5)" aria-label="Next to rice preference">Next</button>
    </div>

    <div id="step5" class="step" tabindex="0">
      <h2>Step 5: Rice Preference</h2>
      <p>Can the client have meals with rice?</p>
      <select id="ricePref" aria-label="Rice preference select">
        <option value="yes">Yes, with rice</option>
        <option value="no">No rice</option>
      </select>
      <button onclick="nextStep(6)" aria-label="Next to meal plan generation">Next</button>
    </div>

    <div id="step6" class="step" tabindex="0">
      <h2>Step 6: Meal Plan</h2>
      <div id="mealPlan"></div>
      <div class="button-row">
        <button id="generateBtn" onclick="generateMealPlan()">Generate Meal Plan</button>
        <button id="regenerateBtn" style="display:none;" onclick="regenerateMealPlan()">Regenerate Meal Plan</button>
      </div>
      <div id="weeklyMealPlans"></div>
    </div>
  </div>
</div>

<script>
  const meals = [
    { name: "Adobo Chicken", calories: 320, protein: 30, carbs: 10, fat: 18, allergens: [], containsRice: false },
    { name: "Sinigang na Baboy", calories: 280, protein: 28, carbs: 15, fat: 12, allergens: [], containsRice: false },
    { name: "Laing", calories: 300, protein: 12, carbs: 20, fat: 22, allergens: [], containsRice: false },
    { name: "Lechon Kawali", calories: 400, protein: 35, carbs: 0, fat: 30, allergens: [], containsRice: false },
    { name: "Tuna Salad", calories: 180, protein: 20, carbs: 5, fat: 8, allergens: ['fish'], containsRice: false },
    { name: "Beef Stir Fry", calories: 300, protein: 25, carbs: 20, fat: 15, allergens: [], containsRice: false },
    { name: "Fried Rice", calories: 250, protein: 7, carbs: 40, fat: 8, allergens: ['gluten'], containsRice: true },
    { name: "Steamed Rice", calories: 210, protein: 4, carbs: 45, fat: 0, allergens: [], containsRice: true },
    { name: "Peanut Bar Snacks", calories: 150, protein: 5, carbs: 15, fat: 8, allergens: ['nuts'], containsRice: false }
  ];

  const extraMeal = { name: "Herbalife Formula 1 Shake", calories: 200, protein: 9, carbs: 25, fat: 3, allergens: [], containsRice: false };

  const mealImages = {
    "Adobo Chicken": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAIAAAD2Ht6kAAAABnRSTlMAAAAAAABupgeRAAAANUlEQVR4nO3BMQEAAAgDoJvcva+GET3BkDOmTNnTq1ChQoUKFChQoUKFChQoUKFChQoUKFCk6hPmighOTMAAAAASUVORK5CYII=",
    "Sinigang na Baboy": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAIAAAD2Ht6kAAAABnRSTlMAAAAAAABupgeRAAAAJklEQVR4nO3BMQEAAAwCoNm/9EngAAAAAAAAAAAAAAAAAAAAAAAAAAAALgBg+QAAeeMiH7AAAAAASUVORK5CYII=",
    "Laing": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAIAAAD2Ht6kAAAABnRSTlMAAAAAAABupgeRAAAAJElEQVR4nO3BMQEAAAgDoJvcva+GET3BkDOmTNnTq1ChQoUKFChQoUKFChQoUKFChQoUKFCk6hM+qhxGTMAAAAASUVORK5CYII=",
    "Lechon Kawali": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAIAAAD2Ht6kAAAABnRSTlMAAAAAAABupgeRAAAALUlEQVR4nO3BMQEAAAgCoNm/9EntnIy2nTq1ChQoUKFChQoUKFChQoUKFChQoUKFCkKhn6UGiIAAAAASUVORK5CYII=",
    "Tuna Salad": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD",
    "Beef Stir Fry": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD",
    "Fried Rice": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD",
    "Steamed Rice": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD",
    "Peanut Bar Snacks": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD",
    "Herbalife Formula 1 Shake": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD"
  };

  let profiles = {};
  let currentProfile = null;
  let currentStep = 0;
  let currentAllergies = [];
  let riceAllowed = true;

  const profileListEl = document.getElementById("profileList");
  const planListEl = document.getElementById("planList");
  const profileTitleEl = document.getElementById("profileTitle");
  const containerSteps = document.querySelectorAll(".step");

  const profileNameInput = document.getElementById("profileNameInput");
  const goalSelect = document.getElementById("goal");
  const weightInput = document.getElementById("weight");
  const heightInput = document.getElementById("height");
  const ageInput = document.getElementById("age");
  const targetWeightInput = document.getElementById("targetWeight");
  const allergyInput = document.getElementById("allergyInput");
  const ricePrefSelect = document.getElementById("ricePref");
  const mealPlanDiv = document.getElementById("mealPlan");
  const regenerateBtn = document.getElementById("regenerateBtn");
  const newProfileBtn = document.getElementById("newProfileBtn");
  const weeklyMealPlansDiv = document.getElementById("weeklyMealPlans");

  // Event listener for new profile button
  newProfileBtn.addEventListener("click", () => {
    currentProfile = null;
    currentAllergies = [];
    riceAllowed = true;
    clearInputs();
    showStep(0);
    setActiveProfile(null);
    clearPlanList();
    regenerateBtn.style.display = "none";
    weeklyMealPlansDiv.innerHTML = "";
  });

  function clearInputs() {
    profileNameInput.value = "";
    goalSelect.value = "lose";
    weightInput.value = "";
    heightInput.value = "";
    ageInput.value = "";
    targetWeightInput.value = "";
    allergyInput.value = "";
    ricePrefSelect.value = "yes";
    mealPlanDiv.innerHTML = "";
    weeklyMealPlansDiv.innerHTML = "";
  }

  function loadProfiles() {
    const saved = localStorage.getItem("pinoyMealProfiles");
    profiles = saved ? JSON.parse(saved) : {};
    renderProfileList();
  }

  function saveProfiles() {
    localStorage.setItem("pinoyMealProfiles", JSON.stringify(profiles));
  }

  function renderProfileList() {
    profileListEl.innerHTML = "";
    for (const name in profiles) {
      const li = document.createElement("li");
      li.textContent = name;
      li.title = `Client: ${name}`;
      li.onclick = () => loadProfile(name);
      if (currentProfile === name) li.classList.add("active");
      const delBtn = document.createElement("button");
      delBtn.textContent = "X";
      delBtn.className = "delete-btn";
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if (confirm(`Delete profile "${name}"? This cannot be undone.`)) {
          delete profiles[name];
          if (currentProfile === name) {
            currentProfile = null;
            currentAllergies = [];
            riceAllowed = true;
            clearInputs();
            clearPlanList();
            weeklyMealPlansDiv.innerHTML = "";
            showStep(0);
            regenerateBtn.style.display = "none";
          }
          saveProfiles();
          renderProfileList();
        }
      };
      li.appendChild(delBtn);
      profileListEl.appendChild(li);
    }
  }

  function setActiveProfile(name) {
    currentProfile = name;
    renderProfileList();
  }

  function clearPlanList() {
    planListEl.innerHTML = "";
    profileTitleEl.style.display = "none";
  }

  function renderPlanList() {
    planListEl.innerHTML = "";
    profileTitleEl.style.display = "block";
    profileTitleEl.textContent = `Past Meal Plans for ${currentProfile}`;
    const plans = profiles[currentProfile].mealPlans || [];

    plans.forEach((plan, i) => {
      const li = document.createElement("li");
      const planDate = new Date(plan.date);
      li.textContent = planDate.toLocaleString();
      li.title = `Meal plan generated on ${planDate.toLocaleString()}`;
      li.style.cursor = "pointer";
      li.onclick = () => {
        Array.from(planListEl.children).forEach(item => item.classList.remove("active"));
        li.classList.add("active");
        displayMealPlan(plan);
        regenerateBtn.style.display = "inline-block";
        showStep(6);
      };
      planListEl.appendChild(li);
    });

    if (planListEl.firstChild) {
      planListEl.firstChild.classList.add("active");
    }
  }

  function showStep(step) {
    containerSteps.forEach(s => s.classList.remove("active"));
    document.getElementById(`step${step}`).classList.add("active");
    currentStep = step;
  }

  function nextStep(step) {
    if (step === 1) {
      if (!profileNameInput.value.trim()) {
        alert("Please enter a valid client name.");
        return;
      }
    }
    if (step === 3) {
      const weight = parseFloat(weightInput.value);
      const height = parseFloat(heightInput.value);
      const age = parseInt(ageInput.value);
      if (!weight || weight <= 0 || !height || height <= 0 || !age || age <= 0) {
        alert("Please enter valid weight, height, and age.");
        return;
      }
    }
    if(step === 4) {
      const targetWeight = parseFloat(targetWeightInput.value);
      if(!targetWeight || targetWeight <= 0) {
        alert("Please enter a valid target weight.");
        return;
      }
    }
    showStep(step);
  }

  function saveNewProfile() {
    const name = profileNameInput.value.trim();
    if (!name) {
      alert("Please enter a valid client name.");
      return;
    }
    if (profiles[name]) {
      if (!confirm(`Profile "${name}" already exists. Overwrite?`)) return;
    }
    profiles[name] = {
      goal: "lose",
      weight: null,
      height: null,
      age: null,
      targetWeight: null,
      allergies: [],
      riceAllowed: true,
      mealPlans: []
    };
    currentProfile = name;
    saveProfiles();
    renderProfileList();
    goalSelect.value = "lose";
    weightInput.value = "";
    heightInput.value = "";
    ageInput.value = "";
    targetWeightInput.value = "";
    allergyInput.value = "";
    ricePrefSelect.value = "yes";
    showStep(1);
    setActiveProfile(name);
    clearPlanList();
    regenerateBtn.style.display = "none";
    weeklyMealPlansDiv.innerHTML = "";
  }

  function loadProfile(name) {
    const p = profiles[name];
    if (!p) return;
    currentProfile = name;
    setActiveProfile(name);
    profileNameInput.value = name;
    goalSelect.value = p.goal || "lose";
    weightInput.value = p.weight || "";
    heightInput.value = p.height || "";
    ageInput.value = p.age || "";
    targetWeightInput.value = p.targetWeight || "";
    allergyInput.value = (p.allergies || []).join(", ");
    ricePrefSelect.value = (p.riceAllowed === false) ? "no" : "yes";
    currentAllergies = p.allergies || [];
    riceAllowed = p.riceAllowed !== false;
    showStep(1);
    if (p.mealPlans && p.mealPlans.length > 0) {
      renderPlanList();
      renderWeeklyMealPlans();
      displayMealPlan(p.mealPlans[p.mealPlans.length - 1]);
      regenerateBtn.style.display = "inline-block";
    } else {
      clearPlanList();
      mealPlanDiv.innerHTML = "";
      weeklyMealPlansDiv.innerHTML = "";
      regenerateBtn.style.display = "none";
    }
  }

  function calculateBMI(weightKg, heightCm) {
    const heightM = heightCm / 100;
    return weightKg / (heightM * heightM);
  }

  function calculateMacros(caloriesNeeded, weight, goal) {
    let proteinPerKg = 1.8;
    let proteinCalories = proteinPerKg * weight * 4;
    let fatCalories, carbCalories;

    if (goal === 'lose') {
      fatCalories = caloriesNeeded * 0.25;
    } else if (goal === 'gain') {
      fatCalories = caloriesNeeded * 0.20;
    } else {
      fatCalories = caloriesNeeded * 0.25;
    }
    carbCalories = caloriesNeeded - proteinCalories - fatCalories;

    let proteinGrams = proteinCalories / 4;
    let fatGrams = fatCalories / 9;
    let carbGrams = carbCalories / 4;

    proteinGrams = Math.max(0, proteinGrams);
    fatGrams = Math.max(0, fatGrams);
    carbGrams = Math.max(0, carbGrams);

    return {
      protein: proteinGrams.toFixed(1),
      fat: fatGrams.toFixed(1),
      carbs: carbGrams.toFixed(1)
    };
  }

  function filterMeals(allergies, riceAllowed) {
    const lowered = allergies.map(v => v.toLowerCase());
    return meals.filter(m => {
      const allergensLower = m.allergens.map(a => a.toLowerCase());
      for (const allergy of lowered) {
        if (allergensLower.includes(allergy)) return false;
      }
      if (!riceAllowed && m.containsRice) return false;
      return true;
    });
  }

  function generateMealPlan() {
    if (!currentProfile) {
      alert("Please create or select a profile first.");
      return;
    }
    const goal = goalSelect.value;
    const weight = parseFloat(weightInput.value);
    const height = parseFloat(heightInput.value);
    const age = parseInt(ageInput.value);
    const targetWeight = parseFloat(targetWeightInput.value);

    if (!weight || weight <= 0 || !height || height <= 0 || !age || age <= 0 || !targetWeight || targetWeight <= 0) {
      alert("Please enter valid inputs.");
      return;
    }

    // Save allergies and rice preference from inputs
    const allergyStr = allergyInput.value.trim();
    currentAllergies = allergyStr ? allergyStr.split(",").map(a => a.trim().toLowerCase()).filter(a => a) : [];
    riceAllowed = ricePrefSelect.value === "yes";

    // Update profile info
    profiles[currentProfile].goal = goal;
    profiles[currentProfile].weight = weight;
    profiles[currentProfile].height = height;
    profiles[currentProfile].age = age;
    profiles[currentProfile].targetWeight = targetWeight;
    profiles[currentProfile].allergies = currentAllergies;
    profiles[currentProfile].riceAllowed = riceAllowed;

    // Maintenance calories (simplified)
    const maintenanceCalories = weight * (goal === "lose" ? 30 : goal === "gain" ? 35 : 32);
    const calorieAdjustment = 400;
    let calorieTarget;
    if (targetWeight < weight) {
      calorieTarget = Math.max(1200, maintenanceCalories - calorieAdjustment);
    } else if (targetWeight > weight) {
      calorieTarget = maintenanceCalories + calorieAdjustment;
    } else {
      calorieTarget = maintenanceCalories;
    }

    // Filter meals for allergies and riceAllowed
    let availableMeals = filterMeals(currentAllergies, true);
    const riceMeals = availableMeals.filter(m => m.containsRice);
    const nonRiceMeals = availableMeals.filter(m => !m.containsRice);

    // Pick one rice meal if allowed and available
    let riceMealIncluded = null;
    if (riceAllowed && riceMeals.length > 0) {
      const shuffledRice = [...riceMeals].sort(() => 0.5 - Math.random());
      riceMealIncluded = shuffledRice[0];
    }

    // Snack/lunch candidates excluding Herbalife and rice meal if included
    let snackLunchCandidates = nonRiceMeals.filter(m => m.name !== extraMeal.name);
    if (riceMealIncluded) {
      snackLunchCandidates = snackLunchCandidates.filter(m => m.name !== riceMealIncluded.name);
    }

    if (snackLunchCandidates.length < 2) {
      alert("Not enough suitable meals for your allergies and rice preference. Please adjust inputs.");
      return;
    }

    // Pick AM & PM snack randomly
    const shuffledSnacks = [...snackLunchCandidates].sort(() => 0.5 - Math.random());
    const amSnack = shuffledSnacks[0];
    const pmSnack = shuffledSnacks[1];

    // Pick lunch (rice meal if included, else from nonRice)
    let lunch = null;
    if (riceMealIncluded) {
      lunch = riceMealIncluded;
    } else {
      const lunchCandidates = snackLunchCandidates.filter(m => m.name !== amSnack.name && m.name !== pmSnack.name);
      if (lunchCandidates.length === 0) {
        alert("Not enough suitable meals for lunch after selecting snacks. Please adjust.");
        return;
      }
      lunch = [...lunchCandidates].sort(() => 0.5 - Math.random())[0];
    }

    const mealPlan = [
      {...extraMeal, mealTime: "Breakfast"},
      {...amSnack, mealTime: "AM Snack"},
      {...lunch, mealTime: "Lunch"},
      {...pmSnack, mealTime: "PM Snack"},
      {...extraMeal, mealTime: "Dinner"},
    ];

    // Totals
    let totalCalories = mealPlan.reduce((sum,m) => sum + m.calories, 0);
    let totalProtein = mealPlan.reduce((sum,m) => sum + m.protein, 0);
    let totalCarbs = mealPlan.reduce((sum,m) => sum + m.carbs, 0);
    let totalFat = mealPlan.reduce((sum,m) => sum + m.fat, 0);

    let bmi = calculateBMI(weight, height).toFixed(1);
    let targetMacros = calculateMacros(calorieTarget, weight, goal);

    const plan = {
      date: new Date().toISOString(),
      goal,
      weight,
      height,
      age,
      targetWeight,
      bmi,
      caloriesNeeded: calorieTarget,
      targetMacros,
      allergies: currentAllergies,
      riceAllowed,
      meals: mealPlan,
      totals: {
        calories: totalCalories,
        protein: totalProtein,
        carbs: totalCarbs,
        fat: totalFat
      }
    };

    profiles[currentProfile].mealPlans.push(plan);
    saveProfiles();

    renderPlanList();
    renderWeeklyMealPlans();

    displayMealPlan(plan);
    regenerateBtn.style.display = "inline-block";
    showStep(6);
  }

  function regenerateMealPlan() {
    generateMealPlan();
  }

  function displayMealPlan(plan) {
    let output = `<h3>Target Calories: ${plan.caloriesNeeded.toFixed(0)} kcal</h3>`;
    output += `<p><strong>Current Weight:</strong> ${plan.weight.toFixed(1)} kg</p>`;
    output += `<p><strong>Target Weight:</strong> ${plan.targetWeight.toFixed(1)} kg</p>`;
    output += `<p><strong>BMI:</strong> ${plan.bmi} kg/mÂ²</p>`;
    output += `<p><strong>Target Macros:</strong> Protein: ${plan.targetMacros.protein}g | Carbs: ${plan.targetMacros.carbs}g | Fat: ${plan.targetMacros.fat}g</p>`;
    output += `<p><strong>Allergies:</strong> ${plan.allergies.length > 0 ? plan.allergies.join(", ") : "None"}</p>`;
    output += `<p><strong>Rice Allowed:</strong> ${plan.riceAllowed ? "Yes" : "No"}</p>`;
    plan.meals.forEach(m => {
      output += `
        <div class="meal-card">
          <h3>${m.mealTime}: ${m.name}</h3>
          <img src="${mealImages[m.name] || 'https://via.placeholder.com/300'}" alt="${m.name}">
          <p class="macro">Calories: ${m.calories} | Protein: ${m.protein}g | Carbs: ${m.carbs}g | Fat: ${m.fat}g</p>
        </div>
      `;
    });
    output += `<h3>Daily Total: ${plan.totals.calories} kcal | Protein: ${plan.totals.protein}g | Carbs: ${plan.totals.carbs}g | Fat: ${plan.totals.fat}g</h3>`;
    mealPlanDiv.innerHTML = output;
  }

  function renderWeeklyMealPlans() {
    weeklyMealPlansDiv.innerHTML = "";
    if(!currentProfile) return;
    const plans = profiles[currentProfile].mealPlans || [];
    if(plans.length === 0) return;

    const groups = {};
    plans.forEach(p => {
      const day = p.date.substring(0,10);
      if(!groups[day]) groups[day] = [];
      groups[day].push(p);
    });

    const sortedDays = Object.keys(groups).sort((a,b) => b.localeCompare(a));

    sortedDays.slice(0,7).forEach(day => {
      const dayPlans = groups[day];
      const dayDiv = document.createElement("div");
      dayDiv.className = "day-mealplan";
      const dateDisplay = new Date(day).toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "short", day: "numeric"});
      let html = `<h3>${dateDisplay}</h3>`;

      dayPlans.forEach((plan, idx) => {
        html += `<div><strong>Plan ${idx+1}</strong> (Goal: ${plan.goal}, Calories: ${plan.caloriesNeeded.toFixed(0)} kcal)</div>`;
        plan.meals.forEach(m => {
          html += `
            <div class="meal-card" style="margin-bottom:6px;">
              <h4 style="margin:4px 0;">${m.mealTime}: ${m.name}</h4>
              <img src="${mealImages[m.name] || 'https://via.placeholder.com/300'}" alt="${m.name}" style="max-height:100px;">
              <p class="macro" style="margin:2px 0;">Calories: ${m.calories} | Protein: ${m.protein}g | Carbs: ${m.carbs}g | Fat: ${m.fat}g</p>
            </div>
          `;
        });
      });

      dayDiv.innerHTML = html;
      weeklyMealPlansDiv.appendChild(dayDiv);
    });
  }

  function init() {
    loadProfiles();
    if(!currentProfile) {
      showStep(0);
      regenerateBtn.style.display = "none";
      clearPlanList();
      weeklyMealPlansDiv.innerHTML = "";
    }
  }

  init();
</script>

</body>
</html>
